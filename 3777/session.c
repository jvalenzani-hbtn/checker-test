#include <stdlib.h>
#include <string.h>
#include "session.h"

static char *dup_str(const char *s)
{
    size_t n;
    char *p;

    if (!s)
        return NULL;

    n = strlen(s);
    p = (char *)malloc(n + 1);
    if (!p)
        return NULL;

    memcpy(p, s, n + 1);
    return p;
}

session_t *session_create(const char *id, unsigned int uid, const unsigned char *data, size_t data_len)
{
    session_t *s;

    if (!id)
        return NULL;

    s = (session_t *)malloc(sizeof(*s));
    if (!s)
        return NULL;

    s->id = NULL;
    s->data = NULL;
    s->data_len = 0;
    s->uid = uid;

    s->id = dup_str(id);
    if (!s->id) {
        free(s);
        return NULL;
    }

    if (data_len > 0) {
        if (!data) {
            session_destroy(s);
            return NULL;
        }

        s->data = (unsigned char *)malloc(data_len);
        if (!s->data) {
            session_destroy(s);
            return NULL;
        }
        memcpy(s->data, data, data_len);
        s->data_len = data_len;
    }

    return s;
}

int session_set_data(session_t *s, const unsigned char *data, size_t data_len)
{
    unsigned char *tmp;

    if (!s)
        return 0;

    if (data_len == 0) {
        free(s->data);
        s->data = NULL;
        s->data_len = 0;
        return 1;
    }

    if (!data)
        return 0;

    tmp = (unsigned char *)realloc(s->data, data_len);
    if (!tmp)
        return 0;

    s->data = tmp;
    memcpy(s->data, data, data_len);
    s->data_len = data_len;
    return 1;
}

void session_destroy(session_t *s)
{
    if (!s)
        return;

    free(s->id);
    s->id = NULL;

    free(s->data);
    s->data = NULL;
    s->data_len = 0;

    free(s);
}
